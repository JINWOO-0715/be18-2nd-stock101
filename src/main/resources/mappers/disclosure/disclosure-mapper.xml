<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.monstersinc.stock101.disclosure.repository.DisclosureSourceRepository">

    <resultMap id="DisclosureSourceMap" type="com.monstersinc.stock101.disclosure.domain.DisclosureSource">
        <id property="sourceId" column="source_id"/>
        <result property="userId" column="user_id"/>
        <result property="stockId" column="stock_id"/>
        <result property="rceptNo" column="rcept_no"/>
        <result property="filePath" column="file_path"/>
        <result property="fileHash" column="file_hash"/>
        <result property="fileSize" column="file_size"/>
        <result property="storageType" column="storage_type"/>
        <result property="status" column="status"/>
        <result property="companyName" column="company_name"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 소스 파일 저장 -->
    <insert id="save" useGeneratedKeys="true" keyProperty="sourceId">
        INSERT INTO documents (
             user_id, stock_id, file_path, file_hash, file_size, storage_type, status
        ) VALUES (
             #{userId}, #{stockId}, #{filePath}, #{fileHash}, #{fileSize}, #{storageType}, #{status}
        )
    </insert>

    <update id="updateStatus">
        UPDATE documents
        SET
            status = #{status},
            updated_at = NOW()
        WHERE source_id = #{sourceId}
    </update>

    <!-- ID로 조회 -->
    <select id="findById" resultMap="DisclosureSourceMap">
        SELECT * FROM documents WHERE source_id = #{sourceId}
    </select>

    <!-- DART 접수번호로 조회 -->
    <select id="findByRceptNo" resultMap="DisclosureSourceMap">
        SELECT * FROM documents WHERE rcept_no = #{rceptNo} LIMIT 1
    </select>

    <!-- 파일 해시로 조회 (중복 체크) -->
    <select id="findByFileHash" resultMap="DisclosureSourceMap">
        SELECT * FROM documents WHERE file_hash = #{fileHash} LIMIT 1
    </select>

    <!-- DART 접수번호로 목록 조회 -->
    <select id="findAllByRceptNo" resultMap="DisclosureSourceMap">
        SELECT * FROM documents
        WHERE rcept_no = #{rceptNo} 
        ORDER BY created_at DESC
    </select>

    <!-- 삭제 -->
    <delete id="deleteById">
        DELETE FROM documents WHERE source_id = #{sourceId}
    </delete>

    <!-- 파일 해시 존재 여부 확인 -->
    <select id="existsByFileHash" resultType="boolean">
        SELECT EXISTS(SELECT 1 FROM documents WHERE file_hash = #{fileHash})
    </select>

</mapper>
