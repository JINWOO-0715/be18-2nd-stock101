<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.monstersinc.stock101.disclosure.repository.DocumentChunkRepository">

    <resultMap id="ChunkMap" type="com.monstersinc.stock101.disclosure.domain.DocumentChunk">
        <id property="chunkId" column="chunk_id"/>
        <result property="documentId" column="document_id"/>
        <result property="chunkIndex" column="chunk_index"/>
        <result property="chunkText" column="chunk_text"/>
        <result property="pageNumber" column="page_number"/>
        <result property="startChar" column="start_char"/>
        <result property="endChar" column="end_char"/>
        <result property="tokenCount" column="token_count"/>
        <result property="embeddingVector" column="embedding_vector"/>
        <result property="metadata" column="metadata"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <insert id="save" useGeneratedKeys="true" keyProperty="chunkId">
        INSERT INTO document_chunks (
            document_id, chunk_index, chunk_text, page_number, 
            start_char, end_char, token_count, embedding_vector, metadata
        ) VALUES (
            #{documentId}, #{chunkIndex}, #{chunkText}, #{pageNumber},
            #{startChar}, #{endChar}, #{tokenCount}, #{embeddingVector}, #{metadata}
        )
    </insert>

    <insert id="saveAll" useGeneratedKeys="true" keyProperty="chunkId">
        INSERT INTO document_chunks (
            document_id, chunk_index, chunk_text, page_number, 
            start_char, end_char, token_count, embedding_vector, metadata
        ) VALUES 
        <foreach collection="chunks" item="chunk" separator=",">
        (
            #{chunk.documentId}, #{chunk.chunkIndex}, #{chunk.chunkText}, #{chunk.pageNumber},
            #{chunk.startChar}, #{chunk.endChar}, #{chunk.tokenCount}, #{chunk.embeddingVector}, #{chunk.metadata}
        )
        </foreach>
    </insert>

    <select id="findByDocumentId" resultMap="ChunkMap">
        SELECT * FROM document_chunks WHERE document_id = #{documentId} ORDER BY chunk_index ASC
    </select>
    
    <select id="findAllEmbeddingsByStockId" resultMap="ChunkMap">
        SELECT c.* 
        FROM document_chunks c
        JOIN disclosure_documents d ON c.document_id = d.document_id
        WHERE d.stock_id = #{stockId}
        AND c.embedding_vector IS NOT NULL
    </select>

    <delete id="deleteByDocumentId">
        DELETE FROM document_chunks WHERE document_id = #{documentId}
    </delete>

</mapper>
